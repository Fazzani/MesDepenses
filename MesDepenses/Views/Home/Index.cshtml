@{
    ViewBag.Title = "Home Page";
}
@section scripts {
    <script>

        //var carteregex = "^carte[ ]+([0-9]{6})+[ ]+cb:\\*([0-9]{7})[ ]+([a-z-A-Z.]+)+[ ]+([0-9]{2})(.+)$";
        var carteregex = "^carte[ ]+([0-9]{6})+[ ]+cb:\\*([0-9]{7})[ ]+(.+)$";

        var OperationVM = function (montant, libelle, datevaleur, reference, compte) {
            var self = this;
            this.Montant = ko.observable(montant);
            this.Libelle = ko.observable(libelle);
            this.Datevaleur = ko.observable(datevaleur);
            this.Reference = ko.observable(reference);
            this.Compte = ko.observable(compte);
            this.isCarte = ko.observable(false);
            this.isPrlv = ko.observable(false);
            this.isRetrait = ko.observable(false);
            this.isCheque = ko.observable(false);
            this.$type = 'OperationVM';
            this.SimpleLibelle = ko.dependentObservable(function () {
                var myRegexp = new RegExp(carteregex, "gi");
                //console.log(self.Libelle());

                var match = myRegexp.exec(self.Libelle());
                if (match != null) {
                    self.isCarte = true;
                    return match[3];
                }
                return self.Libelle();
            }, this);


        };

        var urlGetData = '@Url.Action("ReadData", "Home")';
        var ViewModel = function () {
            var self = this;

            self.items = ko.observableArray();

            self.compteLength = ko.computed(function () {
                return self.items().length;
            }, this);

            self.groupBy = function () {
                var tmp = _.groupBy(self.items(), function (item) {
                    return item.Montant().length;
                });
                self.items(tmp);
            };

            self.sortBy = function () {
                self.items(_.sortBy(self.items(), function (item) { return parseInt(item.Montant()); }));
            };

            self.load = function () {
                $.getJSON(urlGetData, function (data) {
                    //console.log(JSON.parse(data));
                    var mappedData = ko.utils.arrayMap(JSON.parse(data), function (item) {
                        return new OperationVM(item.Montant, item.Libelle, item.Datevaleur, item.Reference, item.Compte);
                    });
                    self.items(mappedData);

                });
            };
            self.load();
        };
        $(function () {
            ko.applyBindings(new ViewModel());
            $("[data-toggle='tooltip']").tooltip();
        });
    </script>

    @*<script src="~/Scripts/Custom/ViewModel/IndexVM.js"></script>*@

}

@section featured {
    <section class="featured">
        <div class="content-wrapper">
            <hgroup class="title">
                <h1>@ViewBag.Title.</h1>
                <h2>@ViewBag.Message</h2>
            </hgroup>
            <p>
            </p>
        </div>
    </section>
}
<h3>Mes Opérations</h3>

<div class="table-responsive">
    <table class="table table-striped table-hover table-condensed">
        <thead>
            <tr>
                <th>Libellé
                </th>
                <th>Date
                </th>
                <th>Référence
                </th>
                <th>Montant
                </th>
            </tr>
        </thead>
        <tbody data-bind="foreach: items">
            <tr data-toggle="tooltip" data-bind="css: { 'warning': Montant() < 0, 'success': Montant() > 0, 'danger': Montant() <= -1000 }, tooltip: { title: Libelle, trigger: 'hover', placement:'bottom' }" data-container="body">
                <td data-bind="text: SimpleLibelle"></td>
                <td data-bind="text: Datevaleur"></td>
                <td data-bind="text: Reference"></td>
                <td data-bind="text: Montant"></td>
            </tr>
        </tbody>
    </table>
</div>
<div class="actions">
    <input type="button" value="group by" data-bind="click: groupBy" />
    <input type="button" value="sort by" data-bind="click: sortBy" />
</div>
